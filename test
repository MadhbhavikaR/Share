import org.activiti.engine.RuntimeService;
import org.activiti.engine.TaskService;
import org.activiti.engine.delegate.TaskListener;
import org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration;
import org.activiti.engine.impl.persistence.entity.TaskEntity;
import org.activiti.spring.SpringProcessEngineConfiguration;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.annotation.PostConstruct;

@Configuration
public class ActivitiConfiguration {

    @Autowired
    private RuntimeService runtimeService;

    @Autowired
    private TaskService taskService;

    @Autowired
    private CustomTaskListener customTaskListener;

    @Autowired
    private SpringProcessEngineConfiguration processEngineConfiguration;

    @PostConstruct
    public void registerTaskListener() {
        // Define a listener for a specific task in the process instance
        processEngineConfiguration.getProcessEngineConfigurationConfigurer().addConfigurator(
            configuration -> {
                configuration.getTaskService().addEventListener(
                    TaskEntity.class,
                    customTaskListener
                );
            }
        );
    }
}





@Bean
@DependsOn("dataSource")
public SpringProcessEngineConfiguration processEngineConfiguration(DataSource dataSource, PlatformTransactionManager transactionManager) {
    SpringProcessEngineConfiguration config = new SpringProcessEngineConfiguration();
    config.setDataSource(dataSource);
    config.setTransactionManager(transactionManager);
    config.setDatabaseSchemaUpdate(allowActivitySchemaUpdate);
    config.setDatabaseSchema(schemaName);
//        config.setJobExecutorActivate(true);
    return config;
}


@Bean
public ProcessEngine processEngine(SpringProcessEngineConfiguration config) {
    return config.buildProcessEngine();
}

@Bean
public RepositoryService repositoryService(ProcessEngine processEngine) {
    return processEngine.getRepositoryService();
}

@Bean
public RuntimeService runtimeService(ProcessEngine processEngine) {
    return processEngine.getRuntimeService();
}

@Bean
public TaskService taskService(ProcessEngine processEngine) {
    return processEngine.getTaskService();
}
